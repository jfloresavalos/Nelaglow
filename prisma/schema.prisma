generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN
  OPERATOR
}

enum OrderStatus {
  PENDING
  STOCK_RESERVED
  PARTIAL_PAYMENT
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ShippingType {
  PROVINCIA
  DELIVERY_LIMA
  RECOJO_TIENDA
}

enum PaymentMethod {
  YAPE
  TRANSFERENCIA
  EFECTIVO
  CONTRAENTREGA
}

enum DeliveryStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum StockMovementType {
  PURCHASE_IN    // Ingreso manual (compra/restock)
  SALE_OUT       // Automático al crear pedido
  RETURN_IN      // Automático al cancelar pedido
  ADJUSTMENT_IN  // Ajuste positivo manual
  ADJUSTMENT_OUT // Ajuste negativo manual
}

// ==================== MODELS ====================

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  name         String
  role         UserRole @default(OPERATOR)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  orders              Order[]
  orderStatusChanges  OrderStatusHistory[]
  stockMovements      StockMovement[]

  @@map("users")
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id                String   @id @default(cuid())
  name              String
  description       String?
  color             String?  // e.g. "Rojo", "Azul", "Verde"
  parentProductId   String?  // null = producto base o independiente
  price             Decimal  @db.Decimal(10, 2)
  costPrice         Decimal? @db.Decimal(10, 2)
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5)
  categoryId        String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  category       Category?       @relation(fields: [categoryId], references: [id])
  images         ProductImage[]
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  // Relación auto-referencial para variantes de color
  parent   Product?  @relation("ProductVariants", fields: [parentProductId], references: [id])
  variants Product[] @relation("ProductVariants")

  @@index([categoryId])
  @@index([name])
  @@index([isActive])
  @@index([isActive, stock])
  @@index([parentProductId])
  @@map("products")
}

model ProductImage {
  id           String   @id @default(cuid())
  productId    String
  imageUrl     String
  thumbnailUrl String?
  isPrimary    Boolean  @default(false)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

model Client {
  id         String   @id @default(cuid())
  dni        String?  @unique
  name       String
  phone      String?
  email      String?
  address    String?
  department String?
  province   String?
  district   String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  orders Order[]

  @@index([name])
  @@index([phone])
  @@map("clients")
}

model Order {
  id              String       @id @default(cuid())
  orderNumber     String       @unique
  clientId        String
  userId          String
  status          OrderStatus  @default(PENDING)
  shippingType    ShippingType
  subtotalAmount  Decimal      @db.Decimal(10, 2)
  shippingAmount  Decimal      @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal      @db.Decimal(10, 2)
  paidAmount      Decimal      @default(0) @db.Decimal(10, 2)
  remainingAmount Decimal      @db.Decimal(10, 2)
  notes           String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  client         Client               @relation(fields: [clientId], references: [id])
  user           User                 @relation(fields: [userId], references: [id])
  items          OrderItem[]
  payments       Payment[]
  shipping       Shipping?
  statusHistory  OrderStatusHistory[]
  stockMovements StockMovement[]

  @@index([clientId])
  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(cuid())
  orderId       String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  proofImageUrl String?
  notes         String?
  receivedAt    DateTime      @default(now())
  createdAt     DateTime      @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("payments")
}

model Shipping {
  id               String         @id @default(cuid())
  orderId          String         @unique
  recipientName    String
  recipientPhone   String
  recipientAddress String?
  department       String?
  province         String?
  district         String?
  agencyName       String?
  agencyAddress    String?
  trackingCode     String?
  agencyVoucherUrl String?
  internalCode     String?
  deliveryFee      Decimal?       @db.Decimal(10, 2)
  deliveryStatus   DeliveryStatus @default(PENDING)
  isContraentrega  Boolean        @default(false)
  shippedAt        DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shippings")
}

model OrderStatusHistory {
  id         String      @id @default(cuid())
  orderId    String
  fromStatus OrderStatus?
  toStatus   OrderStatus
  changedBy  String
  notes      String?
  createdAt  DateTime    @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [changedBy], references: [id])

  @@index([orderId])
  @@map("order_status_history")
}

model OrderCounter {
  id      String @id @default("default")
  lastNum Int    @default(0)

  @@map("order_counter")
}

model StockMovement {
  id        String            @id @default(cuid())
  productId String
  type      StockMovementType
  quantity  Int               // siempre positivo; dirección implícita en el tipo
  unitCost  Decimal?          @db.Decimal(10, 2)
  notes     String?
  reference String?           // número de pedido (NGL-XXXX) para SALE_OUT / RETURN_IN
  orderId   String?
  userId    String
  createdAt DateTime          @default(now())

  product Product @relation(fields: [productId], references: [id])
  order   Order?  @relation(fields: [orderId],   references: [id])
  user    User    @relation(fields: [userId],     references: [id])

  @@index([productId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}
